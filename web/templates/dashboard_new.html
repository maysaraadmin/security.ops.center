{% extends "base_new.html" %}

{% block title %}Dashboard - EDR Agent{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .stat-card.primary {
        border-left-color: var(--primary-color);
    }
    
    .stat-card.success {
        border-left-color: var(--success-color);
    }
    
    .stat-card.warning {
        border-left-color: var(--warning-color);
    }
    
    .stat-card.danger {
        border-left-color: var(--danger-color);
    }
    
    .stat-card .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .stat-card .stat-label {
        color: var(--gray-color);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-card .stat-icon {
        font-size: 2rem;
        opacity: 0.2;
        position: absolute;
        right: 1.5rem;
        top: 50%;
        transform: translateY(-50%);
    }
    
    .recent-events {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .event-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s;
    }
    
    .event-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .event-item:last-child {
        border-bottom: none;
    }
    
    .event-severity {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .severity-high {
        background-color: var(--danger-color);
    }
    
    .severity-medium {
        background-color: var(--warning-color);
    }
    
    .severity-low {
        background-color: var(--info-color);
    }
    
    .severity-info {
        background-color: var(--primary-color);
    }
    
    .activity-timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .activity-timeline::before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 7px;
        width: 2px;
        background-color: rgba(0, 0, 0, 0.1);
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
        padding-left: 1.5rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -2rem;
        top: 0.25rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--primary-color);
        border: 2px solid var(--white);
        z-index: 1;
    }
    
    .timeline-item.warning::before {
        background-color: var(--warning-color);
    }
    
    .timeline-item.danger::before {
        background-color: var(--danger-color);
    }
    
    .timeline-item.success::before {
        background-color: var(--success-color);
    }
    
    .timeline-time {
        font-size: 0.75rem;
        color: var(--gray-color);
    }
    
    .chart-container {
        position: relative;
        height: 250px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="h4 mb-0">Dashboard</h2>
        <nav aria-label="breadcrumb" class="mt-2">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-4">
        <div class="card stat-card primary h-100">
            <div class="card-body position-relative">
                <div class="stat-value" id="total-events">0</div>
                <div class="stat-label">Total Events</div>
                <div class="stat-icon">
                    <i class="bi bi-activity"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card success h-100">
            <div class="card-body position-relative">
                <div class="stat-value" id="alerts-today">0</div>
                <div class="stat-label">Alerts Today</div>
                <div class="stat-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card warning h-100">
            <div class="card-body position-relative">
                <div class="stat-value" id="threats-blocked">0</div>
                <div class="stat-label">Threats Blocked</div>
                <div class="stat-icon">
                    <i class="bi bi-shield-check"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card danger h-100">
            <div class="card-body position-relative">
                <div class="stat-value" id="high-severity">0</div>
                <div class="stat-label">High Severity</div>
                <div class="stat-icon">
                    <i class="bi bi-exclamation-octagon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">System Metrics</h6>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary active" data-period="24h">24h</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-period="7d">7d</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-period="30d">30d</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="metricsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0">Threat Distribution</h6>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <div class="chart-container" style="height: 200px; width: 200px;">
                    <canvas id="threatChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Events and Activity -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Recent Events</h6>
                <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Source</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="recent-events-body">
                            <!-- Events will be populated by JavaScript -->
                            <tr>
                                <td colspan="5" class="text-center py-4">Loading events...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0">Recent Activity</h6>
            </div>
            <div class="card-body">
                <div class="activity-timeline" id="activity-timeline">
                    <div class="timeline-item">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0">EDR Agent Started</h6>
                            <span class="timeline-time">Just now</span>
                        </div>
                        <p class="text-muted small mb-0">EDR agent has been started successfully.</p>
                    </div>
                    <div class="timeline-item warning">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0">Suspicious Process</h6>
                            <span class="timeline-time">2 min ago</span>
                        </div>
                        <p class="text-muted small mb-0">Suspicious process detected: powershell.exe</p>
                    </div>
                    <div class="timeline-item danger">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0">High Severity Alert</h6>
                            <span class="timeline-time">15 min ago</span>
                        </div>
                        <p class="text-muted small mb-0">Potential malware detected in downloads folder</p>
                    </div>
                    <div class="timeline-item success">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="mb-0">Threat Contained</h6>
                            <span class="timeline-time">1 hour ago</span>
                        </div>
                        <p class="text-muted small mb-0">Successfully quarantined malicious file</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize WebSocket connection
const socket = io();

// Chart instances
let metricsChart = null;
let threatChart = null;

// Format date for display
function formatDate(dateString) {
    const options = { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    };
    return new Date(dateString).toLocaleString(undefined, options);
}

// Get severity badge HTML
function getSeverityBadge(severity) {
    const severityClass = {
        'CRITICAL': 'danger',
        'HIGH': 'danger',
        'MEDIUM': 'warning',
        'LOW': 'info',
        'INFO': 'primary'
    }[severity] || 'secondary';
    
    return `<span class="badge bg-${severityClass}">${severity}</span>`;
}

// Update stats cards
function updateStats(stats) {
    document.getElementById('total-events').textContent = stats.total_events || 0;
    document.getElementById('alerts-today').textContent = stats.alerts_today || 0;
    document.getElementById('threats-blocked').textContent = stats.threats_blocked || 0;
    document.getElementById('high-severity').textContent = stats.high_severity || 0;
}

// Update recent events table
function updateRecentEvents(events) {
    const tbody = document.getElementById('recent-events-body');
    
    if (!events || events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No events found</td></tr>';
        return;
    }
    
    let rows = '';
    events.forEach(event => {
        rows += `
            <tr class="event-row" data-event-id="${event.event_id}">
                <td>${formatDate(event.timestamp)}</td>
                <td>${event.event_type}</td>
                <td>${getSeverityBadge(event.severity)}</td>
                <td>${event.source}</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary view-details" data-event-id="${event.event_id}">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = rows;
    
    // Add event listeners to view details buttons
    document.querySelectorAll('.view-details').forEach(button => {
        button.addEventListener('click', (e) => {
            const eventId = e.currentTarget.getAttribute('data-event-id');
            // Implement view details functionality
            console.log('View details for event:', eventId);
        });
    });
}

// Initialize metrics chart
function initMetricsChart() {
    const ctx = document.getElementById('metricsChart').getContext('2d');
    metricsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CPU Usage %',
                    data: [],
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Memory Usage %',
                    data: [],
                    borderColor: '#3f37c9',
                    backgroundColor: 'rgba(63, 55, 201, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Usage %'
                    },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

// Initialize threat distribution chart
function initThreatChart() {
    const ctx = document.getElementById('threatChart').getContext('2d');
    threatChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Malware', 'Suspicious', 'Policy Violation', 'Other'],
            datasets: [{
                data: [12, 19, 3, 5],
                backgroundColor: [
                    '#dc3545',
                    '#fd7e14',
                    '#ffc107',
                    '#6c757d'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                }
            },
            cutout: '70%'
        }
    });
}

// Update metrics chart with new data
function updateMetricsChart(metrics) {
    if (!metricsChart) return;
    
    // Limit the number of data points to show
    const maxPoints = 30;
    const timestamps = [];
    const cpuData = [];
    const memData = [];
    
    metrics.slice(-maxPoints).forEach(metric => {
        const date = new Date(metric.timestamp * 1000);
        timestamps.push(date.toLocaleTimeString());
        cpuData.push(metric.cpu_percent);
        memData.push(metric.memory_percent);
    });
    
    metricsChart.data.labels = timestamps;
    metricsChart.data.datasets[0].data = cpuData;
    metricsChart.data.datasets[1].data = memData;
    metricsChart.update();
}

// Socket event handlers
socket.on('connect', () => {
    console.log('Connected to WebSocket server');
    
    // Request initial data
    socket.emit('get_status');
    socket.emit('get_events', { limit: 10 });
    
    // Initialize charts
    initMetricsChart();
    initThreatChart();
});

socket.on('status_update', (status) => {
    console.log('Status update:', status);
    // Update stats cards
    updateStats({
        total_events: status.total_events,
        alerts_today: status.alerts_today || 0,
        threats_blocked: status.threats_blocked || 0,
        high_severity: status.high_severity || 0
    });
});

socket.on('new_event', (event) => {
    console.log('New event:', event);
    // Add the new event to the top of the table
    const tbody = document.getElementById('recent-events-body');
    const newRow = `
        <tr class="event-row" data-event-id="${event.event_id}">
            <td>${formatDate(event.timestamp)}</td>
            <td>${event.event_type}</td>
            <td>${getSeverityBadge(event.severity)}</td>
            <td>${event.source}</td>
            <td>
                <button class="btn btn-sm btn-outline-secondary view-details" data-event-id="${event.event_id}">
                    <i class="bi bi-arrow-right"></i>
                </button>
            </td>
        </tr>
    `;
    
    // Add the new row and remove the last row if we've reached the limit
    const rows = tbody.getElementsByTagName('tr');
    if (rows.length >= 10) {
        tbody.deleteRow(rows.length - 1);
    }
    
    tbody.insertAdjacentHTML('afterbegin', newRow);
});

socket.on('metrics_update', (metrics) => {
    console.log('Metrics update:', metrics);
    updateMetricsChart(metrics);
});

// Handle window resize
window.addEventListener('resize', () => {
    if (metricsChart) metricsChart.resize();
    if (threatChart) threatChart.resize();
});

// Handle period filter buttons
document.querySelectorAll('[data-period]').forEach(button => {
    button.addEventListener('click', (e) => {
        const period = e.currentTarget.getAttribute('data-period');
        
        // Update active button
        document.querySelectorAll('[data-period]').forEach(btn => {
            btn.classList.remove('active');
        });
        e.currentTarget.classList.add('active');
        
        // Here you would typically fetch data for the selected period
        console.log('Selected period:', period);
        
        // For demo purposes, we'll just log the action
        // In a real app, you would make an API call to get data for the selected period
    });
});

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    // Simulate initial data loading
    setTimeout(() => {
        // This would be replaced with actual data from the server
        updateStats({
            total_events: 1245,
            alerts_today: 23,
            threats_blocked: 17,
            high_severity: 5
        });
    }, 1000);
});
</script>
{% endblock %}
