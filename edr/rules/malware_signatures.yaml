# Malware Signatures for EDR
# This file contains signatures for common malware and attack patterns

# Suspicious Process Execution
- rule_id: "mal_susp_exec_001"
  name: "Suspicious Process Execution - PowerShell with Encoded Command"
  description: "Detects PowerShell execution with encoded commands, commonly used in malicious scripts"
  detection_type: "signature"
  severity: "HIGH"
  enabled: true
  tags: ["malware", "powershell", "execution"]
  signatures:
    - name: "PowerShell -EncodedCommand"
      event_type: "process_create"
      process:
        name: "powershell\.exe$"
        command_line: "-enc(?:odedcommand)?\\s+[A-Za-z0-9+/=]+"
      mitre_techniques: ["T1059.001"]

- rule_id: "mal_susp_exec_002"
  name: "Suspicious Process Execution - LOLBINs"
  description: "Detects execution of known Living Off The Land Binaries (LOLBINs)"
  detection_type: "signature"
  severity: "HIGH"
  enabled: true
  tags: ["malware", "lolbins", "execution"]
  signatures:
    - name: "Suspicious LOLBIN Execution"
      event_type: "process_create"
      process:
        path: "(?:[Cc]:\\\\[Ww]indows\\\\[Ss]ystem32\\\\|/usr/bin/|/bin/)"
        name: "(?:mshta\.exe|regsvr32\.exe|rundll32\.exe|wmic\.exe|msiexec\.exe|msbuild\.exe|powershell\.exe|cmd\.exe|bash|sh|python[0-9\\.]*|perl|ruby|php)"
        command_line: "(?i)(?:http|ftp|\\\\\\)"
      mitre_techniques: ["T1218", "T1059"]

# Fileless Malware Detection
- rule_id: "mal_fileless_001"
  name: "Fileless Malware - Process Hollowing"
  description: "Detects potential process hollowing by monitoring for process creation with suspended state"
  detection_type: "behavioral"
  severity: "CRITICAL"
  enabled: true
  tags: ["malware", "fileless", "process_hollowing"]
  conditions:
    - description: "Suspicious process creation pattern"
      event_type: "process_create"
      properties:
        process:
          parent_name: "(?:svchost\\.exe|services\\.exe|explorer\\.exe|winlogon\\.exe|lsass\\.exe|wininit\\.exe)$"
          name: "(?:msiexec\\.exe|rundll32\\.exe|regsvr32\\.exe|wscript\\.exe|cscript\\.exe|mshta\\.exe|powershell\\.exe|cmd\\.exe)$"
  time_window: 5
  mitre_techniques: ["T1055"]

# Ransomware Detection
- rule_id: "mal_ransomware_001"
  name: "Ransomware - Mass File Encryption"
  description: "Detects potential ransomware activity by monitoring for rapid file modifications"
  detection_type: "behavioral"
  severity: "CRITICAL"
  enabled: true
  tags: ["ransomware", "file_encryption"]
  conditions:
    - description: "Rapid file encryption pattern"
      event_type: "file_modify"
      properties:
        file:
          path: "\\.(?:docx?|xlsx?|pptx?|pdf|jpg|jpeg|png|gif|bmp|txt|sql|db|mdb|mdf|sqlite|pst|ost|eml|msg)$"
      count: 50
      timeframe: 30
  mitre_techniques: ["T1486"]

# Credential Dumping
- rule_id: "mal_cred_dump_001"
  name: "Credential Dumping - LSASS Access"
  description: "Detects potential credential dumping via LSASS process access"
  detection_type: "signature"
  severity: "CRITICAL"
  enabled: true
  tags: ["credential_access", "lsass", "mimikatz"]
  signatures:
    - name: "LSASS Process Access"
      event_type: "process_access"
      process:
        name: "(?:procdump\\.exe|mimikatz\\.exe|sekurlsa\\.exe|lsass\\.dmp|taskmgr\\.exe|procexp[0-9]*\\.exe)$"
        command_line: "(?i)(?:lsass|sekurlsa|mimikatz|procdump.*lsass|.*-ma.*lsass|.*-r.*lsass)"
  mitre_techniques: ["T1003.001"]

# Network Anomalies
- rule_id: "net_anomaly_001"
  name: "Network Anomaly - Suspicious Outbound Connection"
  description: "Detects suspicious outbound connections to known malicious IPs or domains"
  detection_type: "signature"
  severity: "HIGH"
  enabled: true
  tags: ["network", "c2", "exfiltration"]
  signatures:
    - name: "Suspicious Domain Pattern"
      event_type: "network_connect"
      network:
        remote_addr: "(?:\d{1,3}\\.){3}\d{1,3}"
        remote_port: "(?:80|443|8080|8443)"
      process:
        name: "(?:svchost\\.exe|lsass\\.exe|explorer\\.exe|wininit\\.exe|services\\.exe|winlogon\\.exe)$"
  mitre_techniques: ["T1071"]

# Persistence Mechanisms
- rule_id: "persist_001"
  name: "Persistence - Suspicious Registry Modification"
  description: "Detects suspicious registry modifications commonly used for persistence"
  detection_type: "signature"
  severity: "HIGH"
  enabled: true
  tags: ["persistence", "registry"]
  signatures:
    - name: "Run/RunOnce Key Modification"
      event_type: "registry_set"
      registry:
        key: "(?i)HK(?:LM|CU|CR)\\\\SOFTWARE\\(?:Wow6432Node\\)?Microsoft\\Windows\\CurrentVersion\\(?:Run|RunOnce|RunServices|RunServicesOnce|RunOnceEx)\\*"
        data: "(?:http|ftp|\\\\|\\.(?:exe|dll|ps1|vbs|js|jse|vbe|wsf|wsh|cmd|bat|ps1|psm1|ps1xml|psc1|pssc|psd1|ps1xml|clixml|psc1|ps1xml|psc1|ps1xml|ps1|ps1|ps1|ps1))"
  mitre_techniques: ["T1547.001"]
